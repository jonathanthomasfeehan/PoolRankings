
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Pool Rankings Profile</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="{{ url_for('static', filename= 'css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename= 'css/pages/profile.css') }}">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>



</head>
<body>

    
    <div>
        <h1>
            Hello {{name}}
        </h1>
    </div>
    <div class="container_fluid">
        <table class="table">
            <thead>
                <tr>
                    <th>You</th>
                    <th>Opponent</th>
                    <th>Result</th>
                    <th>Date</th>
                </tr>
            </thead>
            <tbody id="matches_list">

            </tbody>
        </table>

        <div>
            <form action = '/'>
                <button type = 'submit' name = 'home' class="index_nav_buttons">Home</button>
            </form>
        </div>
    </div>
</body>

<script>
    window.onload = getMatchData;

    function getMatchData(){


        // sends post request, if successful then alerts client

        $.ajax({
            url:'/getUserMatchHistory',
            type:'POST',
            data: {"csrf_token":"{{csrf_token()}}"},
            success:function(response){

                for(var i = response.matches.length-1; i>=0; i--){
                    let Player1 = response.matches[i].Player1
                    let Player2 = response.matches[i].Player2
                    console.log(response.requester)
                    let requester = response.requester
                    let otherplayer = Player1 == requester ? Player2: Player1
                    let newscore = 0
                    let oldscore = 0
                    let scoredelta
                    let requester_win = false
                    let matchDate = response.matches[i].Date
                    if(requester == Player1){
                        newscore = response.matches[i].Player1_new_score 
                        oldscore = response.matches[i].Player1_previous_score
                    }else {
                        newscore = response.matches[i].Player2_new_score 
                        oldscore = response.matches[i].Player2_previous_score
                    }
                    if(newscore > oldscore) {
                        requester_win = true
                        scoredelta = newscore-oldscore
                    }else {
                        requester_win = false
                        scoredelta = oldscore-newscore
                    }

                    document.getElementById("matches_list").innerHTML += 
                    
                    `<tr class = ${(requester_win) ? `table-success` : `table-danger`} > 
                        <td> ${requester}</td>
                        <td> ${otherplayer}</td>
                        <td  ${(requester_win) ? `class = "text-success">+` : `class = "text-danger">-`}${scoredelta} </td>
                        <td> ${matchDate} </td>
                        </tr>
                        `

                }


            },
            error:function(jqXHR, exception){
                console.log(jqXHR)
                if(jqXHR.status==450) {
                    alert("The database could not handle this request at this time. Please try again later")
                }
               

                else{
                    alert("Unexpected server error")


                }
            }

        })
    }



</script>